name: Enhanced Daily Commit Report

on:
  schedule:
    - cron: '59 4 * * *'  # 23:59:59 PerÃº (04:59:59 UTC)
  workflow_dispatch:

env:
  TIMEZONE: 'America/Lima'

jobs:
  check_commits:
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Clone and update repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # Full history

      - name: ðŸ›  Setup environment
        run: |
          sudo timedatectl set-timezone $TIMEZONE
          export TZ=$TIMEZONE
          git config --global user.email "actions@github.com"
          git config --global user.name "GitHub Actions"
       
      - name: Fetch all branches (optimizado)
        run: |
          git config remote.origin.fetch "+refs/heads/:refs/remotes/origin/"
          git fetch --force --tags --prune --prune-tags --progress
          git remote update

      - name: Set script permissions 
        run: |
          chmod +x .github/workflows/commit_helpers.sh   

      - name: ðŸ“Š Generate commit report
        id: generate-report
        run: |
          # Load helper functions
          source .github/workflows/commit_helpers.sh
          
          # Setup reporting
          TODAY=$(date +"%Y-%m-%d")
          echo "REPORT_DATE=${TODAY}" >> $GITHUB_ENV
          
          # Generate HTML report
          REPORT=$(generate_html_report "$TODAY")
          
          # Save report
          echo "$REPORT" > commit_report.html
          echo "commit_report<<EOF" >> $GITHUB_ENV
          cat commit_report.html >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: ðŸ“§ Send email report
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: dihani.cy@gmail.com
          password: ${{ secrets.GMAIL_PASSWORD }}
          subject: "ðŸ“¢ Commit Report - ${{ env.REPORT_DATE }}"
          html_body: ${{ env.commit_report }}
          to: diana.carrasco@inetum.com, devdes673@gmail.com
          from: "GitHub Actions <dihani.cy@gmail.com>"
