name: Daily Commit Report

on:
   schedule:
     - cron: '00 18 * * *'  # Ejecuta todos los d√≠as a las 18:00 UTC (hora configurada)
   workflow_dispatch:  # Permite ejecuci√≥n manual desde GitHub Actions
 
jobs:
   check_commits:
     runs-on: ubuntu-latest
     steps:
       - name: üì• Clonar el repositorio
         uses: actions/checkout@v3
 
       - name: üõ† Configurar Git
         run: |
           git fetch --all
 
       - name: üìä Generar reporte detallado de commits por dia
         run: |
           TODAY=$(date -u +"%Y-%m-%d")
           USERS=("DianaCY-ai" "Dihani")
           EMAILS=("diana.carrasco@inetum.com" "dihani.cy@gmail.com")
           COMMITTED_USERS=()
           REPORT="üîç **Reporte de Commits - $TODAY**\n\n"
 
           for i in "${!USERS[@]}"; do
             USERNAME="${USERS[$i]}"
             EMAIL="${EMAILS[$i]}"

             COMMITS=$(git log --since="$TODAY 00:00" --until="$TODAY 18:00" --author="$USERNAME" --pretty=format:"%H|%s|%cd|%d" --date=format:'%Y-%m-%d %H:%M:%S' --all)
 
             if [ -n "$COMMITS" ]; then
               REPORT+="‚úÖ **$USERNAME (${EMAIL}) subi√≥ cambios:**\n"
               while IFS="|" read -r HASH MESSAGE DATE REF; do
                 BRANCH=$(echo "$REF" | grep -oP "(?<=origin/)[^, ]+" | head -n 1)
                 [ -z "$BRANCH" ] && BRANCH="Desconocida"
 
                 REPORT+="  üîπ **Commit:** $MESSAGE\n"
                 REPORT+="  üÜî **ID del Commit:** \`$HASH\`\n"
                 REPORT+="  üìÖ **Fecha:** $DATE\n"
                 REPORT+="  üåø **Rama:** $BRANCH\n"
                 REPORT+="  üìù **Archivos modificados:**\n"
 
                 FILES=$(git diff-tree --no-commit-id --name-only -r "$HASH")
                 while read -r FILE; do
                   REPORT+="     - $FILE\n"
                 done <<< "$FILES"
 
                 REPORT+="\n"
               done <<< "$COMMITS"
             else
               REPORT+="‚ùå **$USERNAME (${EMAIL}) NO subi√≥ cambios hoy.**\n"
             fi
           done
 
           echo -e "$REPORT" > commit_report.txt
           echo "commit_report<<EOF" >> $GITHUB_ENV
           cat commit_report.txt >> $GITHUB_ENV
           echo "EOF" >> $GITHUB_ENV
 
       - name: üìß Enviar reporte por correo
         uses: dawidd6/action-send-mail@v3
         with:
           server_address: smtp.gmail.com
           server_port: 587
           username: dihani.cy@gmail.com
           password: ${{ secrets.GMAIL_PASSWORD }}
           subject: "üì¢ Reporte de commits diarios - ${{ env.TODAY }}"
           body: ${{ env.commit_report }}
           to: diana.carrasco@inetum.com, devdes673@gmail.com
           from: "Reporte de GitHub <dihani.cy@gmail.com>"
