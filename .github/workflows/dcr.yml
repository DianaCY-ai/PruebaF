name: Daily Commit Report

on:
  schedule:
    - cron: '0 23 * * *' # Se ejecuta a las 23:00:00 hora de Per√∫ (UTC-5)
  workflow_dispatch:

jobs:
  check_commits:
    runs-on: ubuntu-latest
    steps:
      - name: üì• Clonar el repositorio
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: üõ† Configurar Git y Zona Horaria
        run: |
          sudo timedatectl set-timezone America/Lima
          export TZ='America/Lima'
          git config --global user.email "actions@github.com"
          git config --global user.name "GitHub Actions"
          git fetch --all --prune --tags --force
          git pull --all

      - name: üìä Generar reporte detallado de commits
        id: generate-report
        run: |
          TODAY_PERU=$(date +"%Y-%m-%d")
          START_TIME="${TODAY_PERU} 00:00:00 -0500"
          END_TIME="${TODAY_PERU} 23:59:59 -0500"
          CURRENT_TIME_PERU=$(date +"%Y-%m-%d %H:%M:%S %z")
          echo "REPORT_DATE=${TODAY_PERU}" >> $GITHUB_ENV

          USERS=("DianaCY-ai" "Dihani")
          EMAILS=("diana.carrasco@inetum.com" "dihani.cy@gmail.com")

          REPORT="""<html><head><style>
          body { font-family: Arial, sans-serif; color: #333; }
          h2 { color: #2c3e50; border-bottom: 2px solid #eee; }
          table { width: 100%; border-collapse: collapse; }
          th { background: #3498db; color: white; padding: 10px; }
          td { padding: 10px; border-bottom: 1px solid #ddd; }
          .commit-hash { font-family: monospace; color: #2980b9; }
          .no-changes { color: #7f8c8d; }
          </style></head><body>
          <h2>üîç Reporte de Commits - $TODAY_PERU</h2>
          <p>Generado el: $CURRENT_TIME_PERU (hora local Per√∫)</p>"""

          for i in "${!USERS[@]}"; do
            USERNAME="${USERS[$i]}"
            EMAIL="${EMAILS[$i]}"

            COMMITS=$(git log --since="$START_TIME" --until="$END_TIME" --author="$USERNAME" \
                      --pretty=format:"%H|%s|%cd|%d" --date=format:'%Y-%m-%d %H:%M:%S %z' --all)

            if [ -n "$COMMITS" ]; then
              REPORT+="<h3>‚úÖ <strong>$USERNAME</strong> ($EMAIL)</h3><table>
              <tr><th>Mensaje</th><th>ID Commit</th><th>Fecha/Hora</th><th>Rama</th><th>Archivos</th></tr>"
              
              while IFS="|" read -r HASH MESSAGE DATE REF; do
                BRANCH=$(git name-rev --name-only $HASH | awk '{print $2}')
                [ -z "$BRANCH" ] && BRANCH="main"
                
                FILES=$(git diff-tree --no-commit-id --name-only -r "$HASH")
                FILE_LIST="<ul>"
                for FILE in $FILES; do
                  FILE_LIST+="<li>$FILE</li>"
                done
                FILE_LIST+="</ul>"
                
                REPORT+="<tr><td>$MESSAGE</td><td><span class='commit-hash'>${HASH:0:7}</span></td><td>$DATE</td><td>$BRANCH</td><td>$FILE_LIST</td></tr>"
              done <<< "$COMMITS"
              REPORT+="</table>"
            else
              REPORT+="<h3 class='no-changes'>‚ùå $USERNAME ($EMAIL) NO realiz√≥ commits hoy.</h3>"
            fi
          done
          REPORT+="</body></html>"

          echo "$REPORT" > commit_report.html
          echo "commit_report<<EOF" >> $GITHUB_ENV
          cat commit_report.html >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: üìß Enviar reporte por correo
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: devdes673@gmail.com
          password: ${{ secrets.GMAIL_PASSWORD }}
          subject: "üì¢ Reporte Diario de Commits - ${{ env.REPORT_DATE }}"
          html_body: ${{ env.commit_report }}
          to: diana.carrasco@inetum.com, devdes673@gmail.com
          from: "GitHub Actions - Reporte Commits <devdes673@gmail.com>"
          priority: high

