name: Daily Commit Report

on:
  schedule:
    - cron: '00 18 * * *'  # Ejecuta todos los d√≠as a las 18:00 UTC
  workflow_dispatch:

jobs:
  check_commits:
    runs-on: ubuntu-latest
    steps:
      - name: üì• Clonar el repositorio
        uses: actions/checkout@v3

      - name: üõ† Configurar Git
        run: |
          git fetch --all

      - name: üìä Generar reporte detallado en HTML
        run: |
          TODAY=$(date -u +"%Y-%m-%d")
          USERS=("DianaCY-ai" "Dihani")
          EMAILS=("diana.carrasco@inetum.com" "dihani.cy@gmail.com")

          echo "<html><body>" > commit_report.html
          echo "<h2 style='color: #333;'>üîç Reporte de Commits - $TODAY</h2>" >> commit_report.html
          echo "<table style='border-collapse: collapse; width: 100%; font-family: Arial, sans-serif;' border='1'>" >> commit_report.html
          echo "<tr style='background-color: #f2f2f2;'>
                  <th style='padding: 8px; text-align: left;'>üë§ Usuario</th>
                  <th style='padding: 8px; text-align: left;'>üìÖ Fecha y Hora</th>
                  <th style='padding: 8px; text-align: left;'>üìù Mensaje del Commit</th>
                  <th style='padding: 8px; text-align: left;'>üåø Rama</th>
                  <th style='padding: 8px; text-align: left;'>üìÇ Archivos Modificados</th>
               </tr>" >> commit_report.html

          for i in "${!USERS[@]}"; do
            USERNAME="${USERS[$i]}"
            EMAIL="${EMAILS[$i]}"
            
            COMMITS=$(git log --since="$TODAY 00:00" --until="$TODAY 18:00" --author="$USERNAME" --pretty=format:"%H|%s|%cd|%d" --date=format:'%Y-%m-%d %H:%M:%S' --all)

            if [ -n "$COMMITS" ]; then
              while IFS="|" read -r HASH MESSAGE DATE REF; do
                BRANCH=$(echo "$REF" | grep -oP "(?<=origin/)[^, ]+" | head -n 1)
                [ -z "$BRANCH" ] && BRANCH="Desconocida"

                FILES=$(git diff-tree --no-commit-id --name-only -r "$HASH")
                FILES_LIST=""
                while read -r FILE; do
                  FILES_LIST+="<li>$FILE</li>"
                done <<< "$FILES"

                [ -z "$FILES_LIST" ] && FILES_LIST="<i>No hay archivos modificados</i>"

                echo "<tr>
                        <td style='padding: 8px;'>$USERNAME ($EMAIL)</td>
                        <td style='padding: 8px;'>$DATE</td>
                        <td style='padding: 8px;'>$MESSAGE</td>
                        <td style='padding: 8px;'>$BRANCH</td>
                        <td style='padding: 8px;'><ul>$FILES_LIST</ul></td>
                      </tr>" >> commit_report.html
              done <<< "$COMMITS"
            else
              echo "<tr>
                      <td colspan='5' style='padding: 8px; text-align: center;'><b>‚ùå $USERNAME ($EMAIL) NO subi√≥ cambios hoy.</b></td>
                    </tr>" >> commit_report.html
            fi
          done

          echo "</table></body></html>" >> commit_report.html

      - name: üìß Enviar reporte por correo con HTML correctamente formateado
        run: |
          REPORT_BODY=$(cat commit_report.html)
          echo "REPORT_BODY<<EOF" >> $GITHUB_ENV
          echo "$REPORT_BODY" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: üìß Enviar correo
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: dihani.cy@gmail.com
          password: ${{ secrets.GMAIL_PASSWORD }}
          subject: "üì¢ Reporte de commits diarios - ${{ env.TODAY }}"
          body: "${{ env.REPORT_BODY }}"
          content_type: text/html
          to: diana.carrasco@inetum.com, devdes673@gmail.com
          from: "Reporte de GitHub <dihani.cy@gmail.com>"

