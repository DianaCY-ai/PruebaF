name: Daily Commit Report

on:
  schedule:
    - cron: '00 18 * * *'  # Ejecuta todos los d√≠as a las 18:00 UTC (hora configurada)
  workflow_dispatch:  # Permite ejecuci√≥n manual desde GitHub Actions

jobs:
  check_commits:
    runs-on: ubuntu-latest
    steps:
      - name: üì• Clonar el repositorio
        uses: actions/checkout@v3

      - name: üõ† Configurar Git
        run: |
          git fetch --all

      - name: üìä Generar reporte detallado en HTML
        run: |
          TODAY=$(date -u +"%Y-%m-%d")
          USERS=("DianaCY-ai" "Dihani")
          EMAILS=("diana.carrasco@inetum.com" "dihani.cy@gmail.com")
          
          REPORT="<html><body>"
          REPORT+="<h2>üîç Reporte de Commits - $TODAY</h2>"
          REPORT+="<table border='1' cellpadding='5' cellspacing='0' style='border-collapse: collapse;'>"
          REPORT+="<tr>
                      <th>üë§ Usuario</th>
                      <th>üìÖ Fecha y Hora</th>
                      <th>üìù Mensaje del Commit</th>
                      <th>üåø Rama</th>
                      <th>üìÇ Archivos Modificados</th>
                   </tr>"

          for i in "${!USERS[@]}"; do
            USERNAME="${USERS[$i]}"
            EMAIL="${EMAILS[$i]}"
            
            COMMITS=$(git log --since="$TODAY 00:00" --until="$TODAY 18:00" --author="$USERNAME" --pretty=format:"%H|%s|%cd|%d" --date=format:'%Y-%m-%d %H:%M:%S' --all)

            if [ -n "$COMMITS" ]; then
              while IFS="|" read -r HASH MESSAGE DATE REF; do
                BRANCH=$(echo "$REF" | grep -oP "(?<=origin/)[^, ]+" | head -n 1)
                [ -z "$BRANCH" ] && BRANCH="Desconocida"

                FILES=$(git diff-tree --no-commit-id --name-only -r "$HASH")
                FILES_LIST="<ul>"
                while read -r FILE; do
                  FILES_LIST+="<li>$FILE</li>"
                done <<< "$FILES"
                FILES_LIST+="</ul>"

                REPORT+="<tr>
                            <td>$USERNAME ($EMAIL)</td>
                            <td>$DATE</td>
                            <td>$MESSAGE</td>
                            <td>$BRANCH</td>
                            <td>$FILES_LIST</td>
                         </tr>"
              done <<< "$COMMITS"
            else
              REPORT+="<tr>
                          <td colspan='5'>‚ùå <b>$USERNAME ($EMAIL) NO subi√≥ cambios hoy.</b></td>
                        </tr>"
            fi
          done

          REPORT+="</table></body></html>"

          echo "$REPORT" > commit_report.html
          echo "commit_report<<EOF" >> $GITHUB_ENV
          cat commit_report.html >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: üìß Enviar reporte por correo con formato HTML
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: dihani.cy@gmail.com
          password: ${{ secrets.GMAIL_PASSWORD }}
          subject: "üì¢ Reporte de commits diarios - ${{ env.TODAY }}"
          body: ${{ env.commit_report }}
          content_type: text/html
          to: diana.carrasco@inetum.com, devdes673@gmail.com
          from: "Reporte de GitHub <dihani.cy@gmail.com>"

